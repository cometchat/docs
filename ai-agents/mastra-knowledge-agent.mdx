# Mastra Knowledge Agent

A production-ready agent that answers questions grounded in your local
documents. It ships with:

-   **Ingestion tool** to convert PDFs/HTML/Text to markdown in
    `knowledge/<namespace>`.
-   **Lightweight retriever** that searches those markdown files.
-   **Knowledge Agent** that cites sources and asks for new docs only
    when nothing relevant is found.
-   **HTTP endpoints** for ingestion and chat.
-   **CometChat integration pattern** identical to Chef Agent.

------------------------------------------------------------------------

## 1) Quick Start

### Prereqs

-   Node 18+\
-   `OPENAI_API_KEY` in `.env`

``` bash
cp .env.example .env
# edit .env and add OPENAI_API_KEY=sk-...
```

### Install & Run

``` bash
pnpm i
npx mastra dev
# Playground: http://localhost:4111
# Knowledge chat: http://localhost:4111/agents/knowledge/chat/new
```

> The Playground chat page uses your registered `knowledge` agent.

------------------------------------------------------------------------

## 2) Project Layout

``` text
.
├─ knowledge/
│  ├─ default/
│  └─ nasaMars/
│     ├─ journey-to-mars-pdf.md
│     ├─ mars-2020-concept-pdf.md
│     └─ perseverance-facts-pdf.md
└─ src/mastra/
   ├─ index.ts                 # Mastra server + custom API routes
   ├─ agents/
   │  ├─ index.ts              # exports { knowledge: knowledgeAgent }
   │  └─ knowledge-agent.ts    # the agent definition
   └─ tools/
      ├─ index.ts              # export * from './ingest-sources' & './docs-retriever'
      ├─ ingest-sources.ts     # URLs & files -> markdown in knowledge/<namespace>
      └─ docs-retriever.ts     # local RAG over markdown/txt
```

------------------------------------------------------------------------

## 3) Agent

``` ts
// src/mastra/agents/knowledge-agent.ts
import { openai } from '@ai-sdk/openai';
import { Agent } from '@mastra/core';
import { docsRetriever, ingestSources } from '../tools';

const DEFAULT_NAMESPACE = 'nasaMars';

export const knowledgeAgent = new Agent({
  name: 'knowledge',
  instructions: `
You are a precise documentation and research assistant.

- Default namespace: "${DEFAULT_NAMESPACE}".
- On every user question, call docsRetriever with this namespace and the user's query.
- Ground your response strictly in retrieved snippets; keep answers concise.
- End with bullet citations (filenames).
- If zero relevant snippets are found, then ask the user to provide sources and call ingestSources with a namespace they choose.
  `,
  tools: { docsRetriever, ingestSources },
  model: openai('gpt-4o'), // or 'gpt-5' if your key supports it
});
```

``` ts
// src/mastra/agents/index.ts
export { knowledgeAgent as knowledge } from './knowledge-agent';
```

------------------------------------------------------------------------

## 4) Server & Routes

``` ts
// src/mastra/index.ts
import { Mastra } from '@mastra/core/mastra';
import { PinoLogger } from '@mastra/loggers';
import { LibSQLStore } from '@mastra/libsql';
import { knowledge } from './agents';

export const mastra = new Mastra({
  agents: { knowledge }, // <-- Agent key must be "knowledge"
  storage: new LibSQLStore({ url: 'file:../mastra.db' }),
  logger: new PinoLogger({ name: 'Mastra', level: 'info' }),
  server: {
    build: { swaggerUI: true }, // http://localhost:4111/swagger-ui
    apiRoutes: [
      // Convert URLs or local file paths to markdown
      {
        method: 'POST',
        path: '/api/tools/ingestSources',
        handler: async (c) => {
          const body = await c.req.json();
          const { ingestSources } = await import('./tools/ingest-sources');
          const result = await ingestSources.execute({
            input: {
              sources: body.sources ?? [],
              files: body.files ?? [],
              namespace: body.namespace ?? 'default',
              allowInsecureTLS: !!body.allowInsecureTLS,
            },
          });
          return c.json(result);
        },
      },
      // Optional debug: ad-hoc doc search
      {
        method: 'POST',
        path: '/api/tools/searchDocs',
        handler: async (c) => {
          const body = await c.req.json();
          const { docsRetriever } = await import('./tools/docs-retriever');
          const out = await docsRetriever.execute({
            input: {
              query: body.query,
              namespace: body.namespace ?? 'default',
              maxResults: body.maxResults ?? 5,
            },
          });
          return c.json(out);
        },
      },
    ],
  },
});
```

------------------------------------------------------------------------

## 5) Ingestion

### Option A --- Seed example NASA docs (optional)

``` bash
mkdir -p knowledge/nasaMars/raw

curl -L -o knowledge/nasaMars/raw/journey-to-mars.pdf   https://www.nasa.gov/wp-content/uploads/2017/11/journey-to-mars-next-steps-20151008_508.pdf
curl -L -o knowledge/nasaMars/raw/mars-2020-concept.pdf   https://www.nasa.gov/wp-content/uploads/2015/04/mission_concept_mars_2020.pdf
curl -L -o knowledge/nasaMars/raw/perseverance-facts.pdf   https://mars.nasa.gov/files/mars2020/Mars2020_Fact_Sheet.pdf

curl -X POST http://localhost:4111/api/tools/ingestSources   -H 'Content-Type: application/json'   -d '{
    "files": [
      "knowledge/nasaMars/raw/journey-to-mars.pdf",
      "knowledge/nasaMars/raw/mars-2020-concept.pdf",
      "knowledge/nasaMars/raw/perseverance-facts.pdf"
    ],
    "namespace": "nasaMars"
  }'
```

This generates markdown files in `knowledge/nasaMars/` that the agent
will search.

### Option B --- Runtime ingestion (users upload new sources)

Post to `/api/tools/ingestSources` with `sources` (URLs or raw text) or
`files` (local paths), and a `namespace` to separate datasets.

------------------------------------------------------------------------

## 6) Ask Questions

### A) Playground

Open: `http://localhost:4111/agents/knowledge/chat/new` and ask: \>
"Summarize NASA's plan for reaching Mars and the role of Mars 2020."

The agent will retrieve from `knowledge/nasaMars/*` and answer with
citations.

### B) REST (for integrations)

``` bash
curl -sS -X POST http://localhost:4111/agents/knowledge/generate   -H 'Content-Type: application/json'   -d '{
    "input": {
      "messages": [
        { "role": "user", "content": "What is Mars 2020 and how does it fit the Mars plan?" }
      ]
    },
    "context": { "namespace": "nasaMars" }
  }'
```

**Important:** `generate` expects `input.messages` (chat format).\
Use `context.namespace` to select a dataset at runtime (defaults to the
agent's prompt value).

------------------------------------------------------------------------

## 7) CometChat Integration (same pattern as Chef)

**Server-side webhook pattern**

1.  Create a CometChat bot / extension that forwards user messages to
    your Mastra agent:

    ``` http
    POST http://<your-mastra-host>/agents/knowledge/generate
    Content-Type: application/json

    {
      "input": { "messages": [{ "role": "user", "content": "<USER_MESSAGE>" }] },
      "context": { "namespace": "nasaMars" }
    }
    ```

2.  Send the `assistant` reply back into the CometChat conversation.

**Notes**

-   Keep Mastra private; sign webhook requests (HMAC/JWT).
-   If you support multiple datasets, map CometChat rooms → `namespace`.

------------------------------------------------------------------------

## 8) Troubleshooting

-   **"Agent with name knowledge not found"**\
    Ensure:

    ``` ts
    // src/mastra/agents/index.ts
    export { knowledgeAgent as knowledge } from './knowledge-agent';
    // src/mastra/index.ts
    agents: { knowledge }
    ```

-   **Playground shows tool validation error**\
    That appears only if the model chooses `ingestSources` without
    inputs. Our prompt discourages this unless retrieval returns zero
    results.

-   **Files not found during ingestion**\
    We handle repo-root resolution in `ingest-sources.ts`. Use
    repo-relative paths like `knowledge/nasaMars/raw/*.pdf` or absolute
    paths.

-   **No answers / empty retrieval**\
    Confirm docs exist:

    ``` bash
    curl -sS -X POST http://localhost:4111/api/tools/searchDocs     -H 'Content-Type: application/json'     -d '{"query":"Mars 2020","namespace":"nasaMars","maxResults":3}'
    ```

------------------------------------------------------------------------

## 9) Extending

-   Swap `docsRetriever` for a vector DB retriever later.
-   Add namespaces per tenant or channel.
-   Add `/api/ask` facade if you prefer a simpler input schema for
    clients.

------------------------------------------------------------------------

## 10) Security & Ops

-   Put Mastra behind your API gateway.
-   Don't expose your `OPENAI_API_KEY` to clients.
-   Log only what you need; redact user PII before storing traces.

------------------------------------------------------------------------

**You're done.** With the files already ingested, your agent will answer
immediately on\
`http://localhost:4111/agents/knowledge/chat/new` and via the `generate`
endpoint above.
