---
title: "Build Your Knowledge Agent with Mastra"
description: "Create a Mastra agent that retrieves answers from local markdown docs (RAG‑lite), test it, deploy it, and connect it to CometChat."
canonical: "https://www.cometchat.com/docs/ai-agents/mastra-knowledge-agent"
---

Turn your product docs into a friendly chat teammate. This guide mirrors the Chef Agent format: you’ll start with a minimal OpenAI-only agent, add a lightweight knowledge tool (RAG‑lite) to read your Markdown docs, then connect the agent to CometChat.

---

import { Card, CardGroup, Callout, Steps, Tabs, Tab, Columns, Accordion, AccordionGroup, Icon } from 'mintlify';

<Callout>
This guide mirrors the **Chef Agent** walkthrough and swaps the domain for **knowledge retrieval**. You’ll build a minimal agent first, then add doc-based retrieval (RAG-lite), and finally connect it to **CometChat**.
</Callout>

## What You’ll Build

<CardGroup>
  <Card title="Mastra Agent" icon="/images/icons/mastra.svg">
    - A small agent powered by OpenAI.
    - Answers questions with short, accurate responses.
  </Card>
  <Card title="RAG-lite Retrieval">
    - Read local Markdown files as your knowledge base.
    - Return answers with a source list.
  </Card>
  <Card title="CometChat Integration" icon="/images/icons/ai-agents.svg">
    - Connect the agent in the dashboard using Agent ID + Deployment URL.
    - Use in 1:1 or group chats.
  </Card>
 </CardGroup>
---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 1</span>
</h3>

## Create Project & Docs (RAG-lite Base)

<Steps>
  <Step title="Scaffold app">Run <code>npx create-mastra@latest</code> and choose Express + OpenAI.</Step>
  <Step title="Set env">Add <code>OPENAI_API_KEY</code> to <code>.env</code>.</Step>
  <Step title="Add kb docs">Create <code>src/kb/</code> and add markdown files.</Step>
  <Step title="Review layout">Confirm generated structure matches below.</Step>
</Steps>

Project layout (condensed):
```txt
my-mastra-app/
  .env
  mastra.config.ts
  src/
    mastra.ts
    server.ts
    agents/knowledge/
      agent.ts
      retriever.ts        # retrieval utility (add)
    tools/
      kb-retrieve.ts      # retrieval tool (add)
    kb/
      pricing.md
      getting-started.md
```

Example doc `src/kb/pricing.md`:
```md
## Pricing
- Free: 100 chats/month
- Pro: 10,000 chats/month, priority support, webhooks
- Enterprise: Custom plan with SSO and SLA
```

---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 2</span>
</h3>

## Create Retrieval Utility

Create **`src/agents/knowledge/retriever.ts`**:
```ts
import fs from 'fs';
import path from 'path';

const KB_DIR = path.join(__dirname, '../../kb');

function tokens(s: string) {
  return s.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').split(/\s+/).filter(Boolean);
}
function score(query: string, doc: string) {
  const q = new Set(tokens(query));
  const d = tokens(doc);
  let hits = 0;
  for (const t of d) if (q.has(t)) hits++;
  return hits / Math.sqrt(d.length || 1);
}

export function loadDocs() {
  const files = fs.readdirSync(KB_DIR).filter(f => f.endsWith('.md'));
  return files.map(f => ({
    title: f.replace('.md', ''),
    content: fs.readFileSync(path.join(KB_DIR, f), 'utf8'),
  }));
}

export function retrieve(query: string, topK = 3) {
  return loadDocs()
    .map(d => ({ ...d, _score: score(query, d.content) }))
    .sort((a, b) => b._score - a._score)
    .slice(0, topK)
    .map(({ title, content }) => ({ title, content }));
}
```

---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 3</span>
</h3>

## Create Retrieval Tool

**`src/tools/kb-retrieve.ts`**:
```ts
import { createTool } from '@mastra/core/tools';
import { z } from 'zod';
import { retrieve } from '../agents/knowledge/retriever';

export const kbRetrieveTool = createTool({
  id: 'kb-retrieve',
  description: 'Return top matching knowledge base markdown docs.',
  inputSchema: z.object({ query: z.string().min(1) }),
  outputSchema: z.object({
    sources: z.array(z.object({ title: z.string(), content: z.string() }))
  }),
  execute: async ({ context }) => {
    const docs = retrieve(context.query, 3);
    return { sources: docs };
  }
});
```

---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 4</span>
</h3>

## Create the Agent

**`src/agents/knowledge/agent.ts`**:
```ts
import { Agent } from '@mastra/core/agent';
import { openai } from '@ai-sdk/openai';
import { kbRetrieveTool } from '../../tools/kb-retrieve';

export const knowledgeAgent = new Agent({
  name: 'knowledge',
  instructions: `You are a precise knowledge agent.\nAlways call kb-retrieve first for context. If docs lack answer say: "I don't have that in my notes."`,
  model: openai('gpt-4o-mini'),
  tools: { 'kb-retrieve': kbRetrieveTool }
});
```

---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 5</span>
</h3>

## Register the Agent in Mastra

**`src/mastra.ts`**:
```ts
import { Mastra } from '@mastra/core/mastra';
import { knowledgeAgent } from './agents/knowledge/agent';

export const mastra = new Mastra({
  agents: { knowledge: knowledgeAgent }
});
```

> Key name `knowledge` defines the REST path: `/api/agents/knowledge/*`.

---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 6</span>
</h3>

## Run the Agent

**`src/server.ts`**:
```ts
import express from 'express';
import bodyParser from 'body-parser';
import { mastra } from './mastra';

const app = express();
app.use(bodyParser.json());

app.post('/api/agents/knowledge/generate', async (req, res) => {
  try {
    const { messages = [] } = req.body || {};
    const result = await mastra.agents.knowledge.respond({ messages });
    res.json(result);
  } catch (e: any) {
    res.status(500).json({ error: e.message });
  }
});

const PORT = process.env.PORT || 4111;
app.listen(PORT, () => console.log(`Mastra API running on :${PORT}`));
```

Run & ping:
```bash
npx mastra dev
curl -s http://localhost:4111/api/agents/knowledge/generate \
  -H 'Content-Type: application/json' \
  -d '{"messages":[{"role":"user","content":"What’s included in pricing?"}]}' | jq .
```

---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 7</span>
</h3>

## Deploy & Production

<AccordionGroup>
  <Accordion title="Ping test">
```bash
curl -X POST http://localhost:4111/api/agents/knowledge/generate \
  -H 'Content-Type: application/json' \
  -d '{"messages":[{"role":"user","content":"ping"}]}'
```
  </Accordion>
  <Accordion title="Temporary public tunnel">
```bash
ngrok http 4111
cloudflared tunnel --url http://localhost:4111
loca.lt --port 4111
```
Append <code>/api/agents/knowledge/generate</code> and copy the HTTPS URL into the Dashboard.
  </Accordion>
  <Accordion title="Vercel serverless example (TypeScript)">
```ts
// api/agents/knowledge/generate.ts
import type { VercelRequest, VercelResponse } from '@vercel/node';
import { knowledgeAgent } from '../../../src/agents/knowledge/agent';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  try {
    const { messages } = req.body || {};
    const result = await knowledgeAgent.respond({ messages });
    return res.status(200).json(result);
  } catch (e: any) {
    return res.status(500).json({ error: e.message || 'Agent error' });
  }
}
```
  </Accordion>
  <Accordion title="Production patterns">
    <ul>
      <li><b>Serverless:</b> One lightweight function per agent.</li>
      <li><b>Container:</b> Long‑lived process; add health checks & logging.</li>
      <li><b>Edge:</b> Keep retrieval tool stateless; externalize persistence.</li>
    </ul>
  </Accordion>
  <Accordion title="Security essentials">
    <ul>
      <li>Rate‑limit (per IP + user).</li>
      <li>Add auth (Bearer/JWT) for non-public usage.</li>
      <li>Log tool calls (name, duration, success/error).</li>
    </ul>
  </Accordion>
  <Accordion title="CometChat mapping">
    Deployment URL = public HTTPS endpoint + <code>/api/agents/knowledge/generate</code>. Mastra Agent ID = <code>knowledge</code>.
  </Accordion>
</AccordionGroup>

---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 8</span>
</h3>

## Configure in CometChat 
<Steps>
  <Step title="Open Dashboard">Open the <a href="https://app.cometchat.com/" target="_blank" rel="noreferrer">CometChat Dashboard</a>.</Step>
  <Step title="Navigate">App → <b>AI Agents</b>.</Step>
  <Step title="Add agent">Provider=Mastra, Agent ID=<code>knowledge</code>, Deployment URL=public generate endpoint.</Step>
  <Step title="(Optional) Enhancements">Add greeting & starter prompts.</Step>
  <Step title="Enable">Save and ensure status is <b>Enabled</b>.</Step>
</Steps>

---

<h3 className="text-2xl font-semibold mb-6 mt-8">
  <span className="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 uppercase tracking-wide text-sm">Step 9</span>
</h3>

## Customize in Chat Builder
<Steps>
  <Step title="Open variant">From <b>AI Agents</b> click the variant (or Get Started).</Step>
  <Step title="Customize & Deploy">Select <b>Customize and Deploy</b>.</Step>
  <Step title="Adjust settings">Theme, layout, features; ensure the knowledge agent is attached.</Step>
  <Step title="Preview">Validate responses & sources display.</Step>
</Steps>

<Frame>
  <img src="/images/ai-agent-chat-builder-preview.png" />
</Frame>

---

## Integrate

Use the widget or UI kit. Display sources as reference chips.

<CardGroup>
  <Card title="Widget" href="/widget/ai-agents" icon="/images/icons/ai-agents.svg" description="Embed quickly with script" />
</CardGroup>

> The configured Mastra agent is already bundled—users can query it immediately.

---

## Test Your Setup

<Steps>
  <Step title="API responds">`/api/agents/knowledge/generate` returns an answer.</Step>
  <Step title="Tool invoked">Sources array present (tool executed).</Step>
  <Step title="Fallback phrase">Out-of-scope query returns: "I don't have that in my notes."</Step>
  <Step title="CometChat reply">Agent responds inside widget / chat builder variant.</Step>
</Steps>

```bash
curl -s http://localhost:4111/api/agents/knowledge/generate \
  -H 'Content-Type: application/json' \
  -d '{"messages":[{"role":"user","content":"What does Pro include?"}]}' | jq .
```

---

## Troubleshooting

- **Agent not found**: Check `agents` map in `mastra.ts`.
- **No sources returned**: Ensure tool id `kb-retrieve` is registered & docs exist in `src/kb`.
- **Empty answers**: Add more docs or move to embeddings.
- **Auth / 401**: Verify `OPENAI_API_KEY`.

---

## Next Steps

- Swap retrieval for embeddings + vector DB (Pinecone, pgvector, LanceDB).
- Add guardrails / evals for hallucination reduction.
- Introduce additional tools (search, analytics) or workflows.
- Implement caching layer for frequent queries.

<Note>
Keep it simple: you now have an agent + retrieval. Upgrade later (vector DB, guardrails) without changing the CometChat steps.
</Note>
